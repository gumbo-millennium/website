sudo: false

language: php

php:
  - 7.2

services:
  - mysql

addons:
  mariadb: '10.3'

before_install:
  - nvm install node
  - npm install -g yarn
  - mysql -e 'CREATE DATABASE IF NOT EXISTS test;'
  - mysql -e 'GRANT ALL ON test.* TO travis;' || true
  - mysql -e 'FLUSH PRIVILEGES;'
  - npm config set "@fortawesome:registry" https://npm.fontawesome.com/
  - npm config set "//npm.fontawesome.com/:_authToken" "${FA_TOKEN}" > /dev/null
  - yarn config set "@fortawesome:registry" https://npm.fontawesome.com/
  - yarn config set "//npm.fontawesome.com/:_authToken" "${FA_TOKEN}" > /dev/null

install:
  - cp .env.travis .env
  - composer install --no-progress --no-suggest -an
  - php artisan key:generate --force
  - yarn install

script:
  - vendor/bin/phpcs
  - ( cd plugin/gumbo-millennium && ../../vendor/bin/phpcs )
  - find resources/assets -type f -name '*.scss' -print | xargs node_modules/.bin/stylelint
  - find resources/assets -type f -name '*.js' -print | xargs node_modules/.bin/eslint

  - yarn run production
  - vendor/bin/phpunit
  - php artisan migrate:fresh

matrix:
  fast_finish: true
